name: Deploy MCP + APIM with Foundry GPT-4o-mini

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: ai-mcp-rg
  AI_PROJECT_RESOURCE_GROUP: ${{ secrets.AI_PROJECT_RESOURCE_GROUP || 'davidsr-AI-RG' }}
  LOCATION: westeurope
  APP_SERVICE_PLAN: mcp-asp-davisanc
  WEBAPP_NAME: mcp-server-app-davisanc
  APIM_NAME: mcp-apim-davisanc
  APIM_PUBLISHER_EMAIL: test@example.com
  APIM_PUBLISHER_NAME: "David Sanchez"
  AI_PROJECT_NAME: ${{ secrets.AI_PROJECT_NAME || 'davidsr-ai-project-resource' }}
  AI_AGENT_NAME: document-analysis-agent

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    # -------------------------------
    # Upgrade Azure CLI to latest version
    # -------------------------------
    - name: Upgrade Azure CLI
      run: |
        curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

    # -------------------------------
    # Azure login
    # -------------------------------
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # -------------------------------
    # Create Resource Group
    # -------------------------------
    - name: Create Resource Group
      run: |
        az group create -n $AZURE_RESOURCE_GROUP -l $LOCATION
    #-------------------------------
    # Installing dependencies
    #-------------------------------
    - name: Install npm dependencies
      run: |
        cd mcp-server
        npm install
    

    # -------------------------------
    # Create App Service Plan (if not exists)
    # -------------------------------
    - name: Create App Service Plan
      run: |
        PLAN_EXISTS=$(az appservice plan show -g $AZURE_RESOURCE_GROUP -n $APP_SERVICE_PLAN 2>/dev/null || echo "")
        if [ -z "$PLAN_EXISTS" ]; then
          echo "Creating App Service Plan..."
          az appservice plan create \
            -g $AZURE_RESOURCE_GROUP \
            -n $APP_SERVICE_PLAN \
            --sku B1 --is-linux
        else
          echo "App Service Plan already exists, skipping creation"
        fi

    # -------------------------------
    # Deploy MCP server
    # -------------------------------
    - name: Create Web App for MCP server
      run: |
        az webapp create \
          -g $AZURE_RESOURCE_GROUP \
          -p $APP_SERVICE_PLAN \
          -n $WEBAPP_NAME \
          --runtime "NODE:22-lts" || echo "Web app already exists or error occurred"

    - name: Set MCP server App Settings
      run: |
        az webapp config appsettings set \
          -g $AZURE_RESOURCE_GROUP \
          -n $WEBAPP_NAME \
          --settings \
            FOUNDRY_ENDPOINT=${{ secrets.FOUNDRY_ENDPOINT }} \
            FOUNDRY_API_KEY=${{ secrets.FOUNDRY_API_KEY }}

    - name: Configure App Service for SSE/MCP Support
      run: |
        az webapp config set \
          -g $AZURE_RESOURCE_GROUP \
          -n $WEBAPP_NAME \
          --web-sockets-enabled true \
          --always-on true \
          --http20-enabled true

    - name: Deploy MCP Server
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ env.WEBAPP_NAME }}
        package: ./mcp-server

    # -------------------------------
    # Create APIM and import MCP API
    # -------------------------------
  
    - name: Create APIM
      continue-on-error: true
      run: |
        az apim create \
          --resource-group $AZURE_RESOURCE_GROUP \
          --name $APIM_NAME \
          --location $LOCATION \
          --publisher-email $APIM_PUBLISHER_EMAIL \
          --publisher-name "$APIM_PUBLISHER_NAME"

    - name: Wait for APIM to be ready
      run: |
        echo "‚è≥ Waiting for APIM activation to complete (up to 5 minutes)..."
        max_attempts=30
        attempt=1
        while [ $attempt -le $max_attempts ]; do
          if az apim show -g $AZURE_RESOURCE_GROUP -n $APIM_NAME 2>/dev/null | grep -q '"provisioningState":"Succeeded"'; then
            echo "‚úÖ APIM is ready!"
            break
          fi
          echo "Waiting... (attempt $attempt/$max_attempts)"
          sleep 10
          attempt=$((attempt + 1))
        done
        if [ $attempt -gt $max_attempts ]; then
          echo "‚ö†Ô∏è  APIM provisioning timeout, continuing anyway..."
        fi

    


    - name: Import MCP API into APIM
      continue-on-error: true
      run: |
        az apim api import \
          -g $AZURE_RESOURCE_GROUP \
          -n $APIM_NAME \
          --path "" \
          --api-id mcp-api \
          --specification-format OpenApi \
          --specification-path ./mcp-server-openapi.yaml \
          --service-url "https://${WEBAPP_NAME}.azurewebsites.net"

    # -------------------------------
    # Use existing Azure AI Foundry Project
    # -------------------------------
    # Note: Assumes you already have an Azure AI Foundry project created
    # The project name should match the AI_PROJECT_NAME environment variable

    # -------------------------------
    # Create/Update Azure AI Agent with MCP
    # -------------------------------
    - name: Install Azure AI Projects SDK
      run: |
        # Install the latest version of azure-ai-projects and azure-ai-agents SDKs
        pip install --upgrade azure-ai-projects azure-ai-agents azure-identity
        pip show azure-ai-projects azure-ai-agents

    - name: Grant Agent Creation Permissions
      continue-on-error: true
      run: |
        bash .github/scripts/grant_permissions.sh

    - name: Wait for Role Assignment Propagation
      run: |
        echo "‚è≥ Waiting 60 seconds for Azure role assignments to propagate..."
        sleep 60
        echo "‚úÖ Role assignment propagation wait complete"

    - name: Get Project Connection Details
      id: project_details
      run: |
        bash .github/scripts/get_project_endpoint.sh

    - name: Create or Update AI Agent
      env:
        AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        PROJECT_ENDPOINT: ${{ steps.project_details.outputs.project_endpoint }}
      run: |
        python .github/scripts/create_agent.py

    - name: Display Agent Information
      if: success()
      run: |
        echo "================================================"
        echo "üéâ Deployment Complete!"
        echo "================================================"
        echo ""
        echo "üåê Web App: https://${WEBAPP_NAME}.azurewebsites.net"
        echo "üîå MCP Endpoint: https://${WEBAPP_NAME}.azurewebsites.net/mcp/sse"
        echo "ü§ñ AI Agent: ${AI_AGENT_NAME}"
        echo "üìä AI Project: ${AI_PROJECT_NAME}"
        echo ""
        if [ -f agent_id.txt ]; then
          echo "üÜî Agent ID: $(cat agent_id.txt)"
        fi
        echo ""
        echo "Next steps:"
        echo "1. Visit the web app to upload documents"
        echo "2. Use Azure AI Foundry to chat with the agent"
        echo "3. Agent will use MCP to access your documents"
        echo "================================================"
